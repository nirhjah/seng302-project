<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <link th:href="@{/css/styles.css}" rel="stylesheet"/>
  <link th:href="@{/css/whiteboard.css}" rel="stylesheet">
  <meta http-equiv="Content-Type" context="text/html; charset=UTF-8">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Whiteboard</title>
</head>
<body class="view-teams-background">
  <div th:insert="~{fragments/navBar.html::navbar(displayTeams=${displayTeams})}"></div>
  <div class="whiteboard-form">
    <div class="whiteboard-wrapper">
      <div class="whiteboard-dropdowns"></div>
      <div class="whiteboard-buttons">
        <button class="select-button active">
          <span class="tooltip">Select (S)</span>
          <img class="selected-svg" src="/image/icons/cursor-selected.svg" />
          <img class="default-svg" src="/image/icons/cursor.svg" />
        </button>
        <button class="draw-button">
          <span class="tooltip">Draw (D)</span>
          <img class="selected-svg" src="/image/icons/pencil-selected.svg" />
          <img class="default-svg" src="/image/icons/pencil.svg" />
        </button>
        <div class="customisation-box draw-button">
          <div class="style-section">
            <div class="header">
              <h5>Style</h5>
              <label>Arrow
                <input class="arrow-checkbox" type="checkbox">
              </label>
            </div>
            <div class="content">
              <button class="draw-style-button-solid active">
                <img class="selected-svg" src="/image/icons/solid-line-selected.svg" />
                <img class="default-svg" src="/image/icons/solid-line.svg" />
              </button>
              <button class="draw-style-button-dashed">
                <img class="selected-svg" src="/image/icons/dashed-line-selected.svg" />
                <img class="default-svg" src="/image/icons/dashed-line.svg" />
              </button>
            </div>
          </div>
          <div class="colour-section">
            <div class="header">
              <h5>Colour</h5>
            </div>
            <div class="content">
              <input class="colour-picker" type="color" value="#ff0000">
              <div>
                <h5>#</h5>
                <input id="colorValue" value="FF0000">
              </div>
            </div>
          </div>
          <div class="width-section">
            <div class="header">
              <h5>Width</h5>
            </div>
            <div class="content">
              <input id="rangeInput" type="range" min="1" max="50" value="5">
              <input type="number" max="50" min="1" id="widthValue" value="5">
            </div>
          </div>
        </div>
        <button class="erase-button">
          <span class="tooltip">Erase (E)</span>
          <img class="selected-svg" src="/image/icons/eraser-selected.svg" />
          <img class="default-svg" src="/image/icons/eraser.svg" />
        </button>
        <button class="shape-button">
          <span class="tooltip">Shape (X)</span>
          <img class="selected-svg" src="/image/icons/circle-selected.svg" />
          <img class="default-svg" src="/image/icons/circle.svg" />
        </button>
        <div class="customisation-box shape-button">
          <input type="color" id="colorPicker" value="#ff0000">
          <input type="range" id="widthSlider" min="1" max="30" value="5">
        </div>
        <button class="delete-button">
          <span class="tooltip">Clear (C)</span>
          <img class="default-svg" src="/image/icons/clear.svg" />
        </button>
      </div>
      <div class="whiteboard">
        <canvas id="canvas" width="560" height="700"></canvas>
      </div>
    </div>
  </div>
</body>
<script>

  document.addEventListener("DOMContentLoaded", function() {
    let canvas = new fabric.Canvas('canvas');
    let activeMode = null;
    canvas.freeDrawingBrush.width = 5;
    canvas.freeDrawingBrush.color = '#ff0000';

    const upperCanvas = document.querySelector(".upper-canvas")


    function handleButtonClick(buttonClass, drawMode, selectMode) {
      const buttons = document.querySelectorAll('.whiteboard-buttons button');
      buttons.forEach(button => {
        if (!button.parentElement.classList.contains("content")) {
          button.classList.remove('active')
        }
      });
      document.querySelector('.' + buttonClass).classList.add('active');

      const customisationBoxes = document.querySelectorAll('.customisation-box');
      customisationBoxes.forEach(box => {
        if (box.classList.contains(buttonClass)) {
          box.classList.toggle("active")
        } else {
          box.classList.remove("active")
        }
      })

      activeMode = buttonClass;
      canvas.isDrawingMode = drawMode;
      canvas.selection = selectMode;
      upperCanvas.classList.remove("erase");
    }



    document.addEventListener('mousedown', function(event) {
      const buttonBox = document.querySelector(".whiteboard-buttons")
      // Check if the clicked element is not the box
      if (!buttonBox.contains(event.target)) {
        const customisationBoxes = document.querySelectorAll('.customisation-box');
        customisationBoxes.forEach(box => box.classList.remove('active'));
      }
    });


    document.querySelector('.draw-button').addEventListener('click', function() {
      handleButtonClick('draw-button', true, false);
    });

    document.querySelector('.erase-button').addEventListener('click', function() {
      handleButtonClick('erase-button', false, false);
      upperCanvas.classList.add("erase");
    });

    document.querySelector('.shape-button').addEventListener('click', function() {
      handleButtonClick('shape-button', false, false);
    });

    document.querySelector('.select-button').addEventListener('click', function() {
      handleButtonClick('select-button', false, true);
    });

    document.querySelector('.delete-button').addEventListener('click', function() {
      canvas.clear();
    });

    const drawStyleButtonSolid = document.querySelector('.draw-style-button-solid');
    const drawStyleButtonDashed = document.querySelector('.draw-style-button-dashed');

    drawStyleButtonSolid.addEventListener('click', function() {
      switchLineTypes()
    });

    drawStyleButtonDashed.addEventListener('click', function() {
      switchLineTypes()
    });

    const rangeInput = document.getElementById('rangeInput');
    const widthValueInput = document.getElementById('widthValue');

    rangeInput.addEventListener('input', function() {
      widthValueInput.value = this.value;
      canvas.freeDrawingBrush.width = parseInt(this.value, 10);
      updateLineType()

    });

    widthValueInput.addEventListener('input', function() {
      const newValue = this.value;
      if (newValue >= 1 && newValue <= 50) {
        rangeInput.value = newValue;
        canvas.freeDrawingBrush.width = parseInt(this.value, 10);
        updateLineType()
      }
    });

    function switchLineTypes() {
      drawStyleButtonSolid.classList.toggle('active')
      drawStyleButtonDashed.classList.toggle('active')
      updateLineType()
    }

    const colorPicker = document.querySelector('.colour-picker');
    const colorValueInput = document.getElementById('colorValue');

    // Event listener for the color picker
    colorPicker.addEventListener('input', function() {
      const newColor = this.value;
      colorValueInput.value = newColor.substr(1).toUpperCase();
      canvas.freeDrawingBrush.color = this.value;
    });

    // Event listener for the color value input
    colorValueInput.addEventListener('input', function() {
      const newColor = this.value;
      if (isValidHexColor(newColor)) {
        colorPicker.value = '#' + newColor;
        canvas.freeDrawingBrush.color = '#' + newColor;
      }
    });

    colorValueInput.addEventListener('keydown', function (event) {
      event.stopPropagation();
    });

    // Function to check if a given string is a valid hex color
    function isValidHexColor(hex) {
      return /^([0-9A-F]{3}){1,2}$/i.test(hex);
    }

    function updateLineType() {
      const canvasWidth = 5 * canvas.freeDrawingBrush.width
      if (drawStyleButtonDashed.classList.contains('active')) {
        canvas.freeDrawingBrush.lineDashOffset = 0;
        canvas.freeDrawingBrush.strokeDashArray = [canvasWidth, canvasWidth / 2];
      } else {
        canvas.freeDrawingBrush.lineDashOffset = 0;
        canvas.freeDrawingBrush.strokeDashArray = [];
      }
    }



    document.addEventListener('keydown', function(event) {
      if (event.key === 's') {
        handleButtonClick('select-button', false, true);
      } else if (event.key === 'd') {
        handleButtonClick('draw-button', true, false);
      } else if (event.key === 'e') {
        handleButtonClick('erase-button', false, false);
        upperCanvas.classList.add("erase");
      } else if (event.key === 'x') {
        handleButtonClick('shape-button', false, false);
        upperCanvas.classList.add("erase");
      } else if (event.key === 'Delete' || event.key === 'Backspace') {
        canvas.remove(canvas.getActiveObject());
      } else if (event.key === 'c') {
        canvas.clear();
      }
    });

    // Event listener for canvas interactions
    canvas.on('mouse:down', function(options) {
      if (activeMode === 'shape-button') {
        let circle = new fabric.Circle({
          left: options.e.clientX - canvas._offset.left,
          top: options.e.clientY - canvas._offset.top,
          radius: 30,
          fill: 'blue'
        });
        canvas.add(circle);
      } else if (activeMode === 'erase-button') {
        let pointer = canvas.getPointer(options.e);
        let objects = canvas.getObjects();
        for (let i = 0; i < objects.length; i++) {
          if (objects[i].containsPoint(pointer)) {
            canvas.remove(objects[i]);
          }
        }
      }
    });
  });

</script>
</html>