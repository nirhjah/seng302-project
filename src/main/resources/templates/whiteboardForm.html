<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <link th:href="@{/css/styles.css}" rel="stylesheet"/>
    <link th:href="@{/css/whiteboard.css}" rel="stylesheet">
    <meta http-equiv="Content-Type" context="text/html; charset=UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Whiteboard</title>
</head>
<body class="view-teams-background">
<div th:insert="~{fragments/navBar.html::navbar(displayTeams=${displayTeams})}"></div>
<div class="whiteboard-form">
    <div class="whiteboard-wrapper">
        <div class="whiteboard-dropdowns">
            <h3>Team 1 Whiteboard</h3>

            <div class="dropdown">
                <label for="pitch">Pitch Type</label>
                <select class="select" id="pitch"></select>
            </div>

            <div class="dropdown">
                <label for="formation">Formation</label>
                <select class="select" id="formation" disabled>
                    <option value="disabled">disabled</option>
                </select>
            </div>

            <div class="line">
                <h3>or</h3>
            </div>

            <div class="dropdown">
                <label for="formation">Line-Up</label>
                <select class="select" id="lineup" disabled>
                    <option value="disabled">disabled</option>
                </select>
            </div>


        </div>
        <div>
            <div class="whiteboard-buttons">
                <button class="select-button active">
                    <span class="tooltip">Select (S)</span>
                    <img class="selected-svg" src="/image/icons/cursor-selected.svg"/>
                    <img class="default-svg" src="/image/icons/cursor.svg"/>
                </button>
                <button class="draw-button">
                    <span class="tooltip">Draw (D)</span>
                    <img class="selected-svg" src="/image/icons/pencil-selected.svg"/>
                    <img class="default-svg" src="/image/icons/pencil.svg"/>
                </button>
                <button class="erase-button">
                    <span class="tooltip">Erase (E)</span>
                    <img class="selected-svg" src="/image/icons/eraser-selected.svg"/>
                    <img class="default-svg" src="/image/icons/eraser.svg"/>
                </button>
                <button class="shape-button">
                    <span class="tooltip">Shape (X)</span>
                    <img class="selected-svg" src="/image/icons/circle-selected.svg"/>
                    <img class="default-svg" src="/image/icons/circle.svg"/>
                </button>
                <button class="delete-button">
                    <span class="tooltip">Clear (C)</span>
                    <img class="default-svg" src="/image/icons/clear.svg"/>
                </button>
            </div>
            <div class="whiteboard">
                <canvas id="canvas" width="560" height="700"></canvas>
            </div>
        </div>
    </div>
</div>
</body>
<script>

    let canvas = new fabric.Canvas('canvas');

    const pitchTypes = ["American Football", "Basketball", "Hockey", "Netball", "Rugby", "Soccer", "Tennis", "Volleyball"];
    const pitchSelect = document.getElementById("pitch");
    pitchTypes.forEach(pitchType => {
        const option = document.createElement("option");
        option.value = pitchType.toLowerCase().replace(" ", "-");
        option.textContent = pitchType;
        pitchSelect.appendChild(option);
    });

    const imagePath = "../image/pitches/";

    pitchSelect.addEventListener("change", function() {
        const selectedValue = this.value;
        const imageUrl = `${imagePath}${selectedValue}.svg`;

        fabric.Image.fromURL(imageUrl, function(img) {
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                scaleX: canvas.width / img.width,
                scaleY: canvas.height / img.height
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        let activeMode = null;
        canvas.freeDrawingBrush.width = 5;
        canvas.freeDrawingBrush.color = '#ff0000';

        const upperCanvas = document.querySelector(".upper-canvas")


        function handleButtonClick(buttonClass, drawMode, selectMode) {
            const buttons = document.querySelectorAll('.whiteboard-buttons button');
            buttons.forEach(button => button.classList.remove('active'));
            document.querySelector('.' + buttonClass).classList.add('active');
            activeMode = buttonClass;
            canvas.isDrawingMode = drawMode;
            canvas.selection = selectMode;
            upperCanvas.classList.remove("erase");
        }


        document.querySelector('.draw-button').addEventListener('click', function () {
            handleButtonClick('draw-button', true, false);
        });

        document.querySelector('.erase-button').addEventListener('click', function () {
            handleButtonClick('erase-button', false, false);
            upperCanvas.classList.add("erase");
        });

        document.querySelector('.shape-button').addEventListener('click', function () {
            handleButtonClick('shape-button', false, false);
        });

        document.querySelector('.select-button').addEventListener('click', function () {
            handleButtonClick('select-button', false, true);
        });

        document.querySelector('.delete-button').addEventListener('click', function () {
            canvas.clear();
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 's') {
                handleButtonClick('select-button', false, true);
            } else if (event.key === 'd') {
                handleButtonClick('draw-button', true, false);
            } else if (event.key === 'e') {
                handleButtonClick('erase-button', false, false);
            } else if (event.key === 'x') {
                handleButtonClick('shape-button', false, false);
                upperCanvas.classList.add("erase");
            } else if (event.key === 'Delete' || event.key === 'Backspace') {
                canvas.remove(canvas.getActiveObject());
            } else if (event.key === 'c') {
                canvas.clear();
            }
        });

        // Event listener for canvas interactions
        canvas.on('mouse:down', function (options) {
            if (activeMode === 'shape-button') {
                let circle = new fabric.Circle({
                    left: options.e.clientX - canvas._offset.left,
                    top: options.e.clientY - canvas._offset.top,
                    radius: 30,
                    fill: 'blue'
                });
                canvas.add(circle);
            } else if (activeMode === 'erase-button') {
                let pointer = canvas.getPointer(options.e);
                let objects = canvas.getObjects();
                for (let i = 0; i < objects.length; i++) {
                    if (objects[i].containsPoint(pointer)) {
                        canvas.remove(objects[i]);
                    }
                }
            }
        });
    });

</script>
</html>