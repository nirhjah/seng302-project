<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <link th:href="@{/css/styles.css}" rel="stylesheet"/>
  <link th:href="@{/css/whiteboard.css}" rel="stylesheet">
  <meta http-equiv="Content-Type" context="text/html; charset=UTF-8">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Whiteboard</title>
</head>
<body class="view-teams-background">
<div th:insert="~{fragments/navBar.html::navbar(displayTeams=${displayTeams})}"></div>
<div class="whiteboard-form">
    <div class="whiteboard-wrapper">
        <div class="whiteboard-dropdowns">
            <h3>Team 1 Whiteboard</h3>

            <div class="dropdown">
                <label for="pitch">Pitch Type</label>
                <select class="select" id="pitch"></select>
            </div>

            <div class="dropdown">
                <label for="formation">Formation</label>
                <select class="select" id="formation" disabled>
                    <option value="disabled">disabled</option>
                </select>
            </div>

            <div class="line">
                <hr>
                <span class="or-text">or</span>
                <hr>
            </div>

            <div class="dropdown">
                <label for="formation">Line-Up</label>
                <select class="select" id="lineup" disabled>
                    <option value="disabled">disabled</option>
                </select>
            </div>


        </div>
        <div>
            <div class="whiteboard-buttons">
                <button class="select-button active">
                    <span class="tooltip">Select (S)</span>
                    <img class="selected-svg" src="/image/icons/cursor-selected.svg"/>
                    <img class="default-svg" src="/image/icons/cursor.svg"/>
                </button>
                <button class="draw-button">
                    <span class="tooltip">Draw (D)</span>
                    <img class="selected-svg" src="/image/icons/pencil-selected.svg"/>
                    <img class="default-svg" src="/image/icons/pencil.svg"/>
                </button>
                <div class="customisation-box draw-button">
                    <div class="style-section">
                        <div class="header">
                            <h5>Style</h5>
                            <label>Arrow
                                <input class="arrow-checkbox" type="checkbox">
                            </label>
                        </div>
                        <div class="content">
                            <button class="draw-style-button-solid active">
                                <img class="selected-svg" src="/image/icons/solid-line-selected.svg"/>
                                <img class="default-svg" src="/image/icons/solid-line.svg"/>
                            </button>
                            <button class="draw-style-button-dashed">
                                <img class="selected-svg" src="/image/icons/dashed-line-selected.svg"/>
                                <img class="default-svg" src="/image/icons/dashed-line.svg"/>
                            </button>
                        </div>
                    </div>
                    <div class="colour-section">
                        <div class="header">
                            <h5>Colour</h5>
                        </div>
                        <div class="content">
                            <input class="colour-picker" type="color" value="#ff0000">
                            <div>
                                <h5>#</h5>
                                <input class="colour-value" id="colourValue" value="FF0000">
                            </div>
                        </div>
                    </div>
                    <div class="width-section">
                        <div class="header">
                            <h5>Width</h5>
                        </div>
                        <div class="content">
                            <input id="rangeInput" type="range" min="1" max="50" value="5">
                            <input type="number" max="50" min="1" id="widthValue" value="5">
                        </div>
                    </div>
                </div>
                <button class="erase-button">
                    <span class="tooltip">Erase (E)</span>
                    <img class="selected-svg" src="/image/icons/eraser-selected.svg"/>
                    <img class="default-svg" src="/image/icons/eraser.svg"/>
                </button>
                <button class="shape-button circle">
                    <span class="tooltip">Shape (X)</span>
                    <img class="selected-svg" src="/image/icons/circle-selected.svg"/>
                    <img class="default-svg" src="/image/icons/circle.svg"/>
                </button>
                <div class="customisation-box shape-button">
                    <div class="style-section">
                        <div class="header">
                            <h5>Style</h5>
                        </div>
                        <div class="content">
                            <button class="draw-style-button-solid active">
                                <img class="selected-svg" src="/image/icons/solid-line-selected.svg"/>
                                <img class="default-svg" src="/image/icons/solid-line.svg"/>
                            </button>
                            <button class="draw-style-button-dashed">
                                <img class="selected-svg" src="/image/icons/dashed-line-selected.svg"/>
                                <img class="default-svg" src="/image/icons/dashed-line.svg"/>
                            </button>
                        </div>
                    </div>
                    <div class="shape-section">
                        <div class="header">
                            <h5>Shape</h5>
                        </div>
                        <div class="content">
                            <button class="shape-button-circle active">
                                <img class="selected-svg" src="/image/icons/circle-selected.svg"/>
                                <img class="default-svg" src="/image/icons/circle.svg"/>
                            </button>
                            <button class="shape-button-ellipse">
                                <img class="selected-svg" src="/image/icons/ellipse-selected.svg"/>
                                <img class="default-svg" src="/image/icons/ellipse.svg"/>
                            </button>
                            <button class="shape-button-triangle">
                                <img class="selected-svg" src="/image/icons/triangle-selected.svg"/>
                                <img class="default-svg" src="/image/icons/triangle.svg"/>
                            </button>
                            <button class="shape-button-square">
                                <img class="selected-svg" src="/image/icons/square-selected.svg"/>
                                <img class="default-svg" src="/image/icons/square.svg"/>
                            </button>
                            <button class="shape-button-rectangle">
                                <img class="selected-svg" src="/image/icons/rectangle-selected.svg"/>
                                <img class="default-svg" src="/image/icons/rectangle.svg"/>
                            </button>
                            <button class="shape-button-line">
                                <img class="selected-svg" src="/image/icons/straight-line-selected.svg"/>
                                <img class="default-svg" src="/image/icons/straight-line.svg"/>
                            </button>
                        </div>
                    </div>
                    <div class="fill-section">
                        <div class="header">
                            <h5>Fill</h5>
                        </div>
                        <div class="content">
                            <input class="colour-picker fill" type="color" value="#ff0000">
                            <button class="visibility-selection active">
                                <img class="selected-svg" src="/image/icons/view.svg"/>
                                <img class="default-svg" src="/image/icons/hide.svg"/>
                            </button>
                            <div>
                                <h5>#</h5>
                                <input class="colour-value" id="colourValueFill" value="FF0000">
                            </div>
                        </div>
                    </div>
                    <div class="outline-section">
                        <div class="header">
                            <h5>Outline</h5>
                        </div>
                        <div class="content">
                            <input class="colour-picker outline" type="color" value="#ff0000">
                            <button class="visibility-selection active">
                                <img class="selected-svg" src="/image/icons/view.svg"/>
                                <img class="default-svg" src="/image/icons/hide.svg"/>
                            </button>
                            <div>
                                <h5>#</h5>
                                <input class="colour-value" id="colourValueOutline" value="FF0000">
                            </div>
                        </div>
                    </div>
                </div>
                <button class="delete-button">
                    <span class="tooltip">Clear (C)</span>
                    <img class="default-svg" src="/image/icons/clear.svg"/>
                </button>
            </div>
            <div class="whiteboard">
                <canvas id="canvas" width="560" height="700"></canvas>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    const pitchTypes = ["American Football", "Basketball", "Hockey", "Netball", "Rugby", "Soccer", "Tennis", "Volleyball"];
    const pitchSelect = document.getElementById("pitch");
    pitchTypes.forEach(pitchType => {
        const option = document.createElement("option");
        option.value = pitchType.toLowerCase().replace(" ", "-");
        option.textContent = pitchType;
        pitchSelect.appendChild(option);
    });

    const imagePath = "../image/pitches/";
    pitchSelect.addEventListener("change", function () {
        const selectedValue = this.value;
        const imageUrl = `${imagePath}${selectedValue}.svg`;
        if (document.querySelector(".canvas-container") !== null) {
            const canvasContainer = document.querySelector(".canvas-container");
            canvasContainer.style.backgroundImage = `url(${imageUrl})`;
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        pitchSelect.value = "soccer";
        let canvas = new fabric.Canvas('canvas');
        let activeMode = null;
        canvas.freeDrawingBrush.width = 5;
        canvas.freeDrawingBrush.colour = '#ff0000';

        const upperCanvas = document.querySelector(".upper-canvas")

        function handleButtonClick(buttonClass, drawMode, selectMode) {
            const buttons = document.querySelectorAll('.whiteboard-buttons button');
            buttons.forEach(button => {
                if (!button.parentElement.classList.contains("content")) {
                    button.classList.remove('active')
                }
            });
            document.querySelector('.' + buttonClass).classList.add('active');

            const customisationBoxes = document.querySelectorAll('.customisation-box');
            customisationBoxes.forEach(box => {
                if (box.classList.contains(buttonClass)) {
                    box.classList.toggle("active")
                } else {
                    box.classList.remove("active")
                }
            })

            activeMode = buttonClass;
            canvas.isDrawingMode = drawMode;
            canvas.selection = selectMode;
            upperCanvas.classList.remove("erase");
        }

        document.addEventListener('mousedown', function (event) {
            const buttonBox = document.querySelector(".whiteboard-buttons")
            // Check if the clicked element is not the box
            if (!buttonBox.contains(event.target)) {
                const customisationBoxes = document.querySelectorAll('.customisation-box');
                customisationBoxes.forEach(box => box.classList.remove('active'));
            }
        });

        document.querySelector('.draw-button').addEventListener('click', function () {
            handleButtonClick('draw-button', true, false);
        });

        document.querySelector('.erase-button').addEventListener('click', function () {
            handleButtonClick('erase-button', false, false);
            upperCanvas.classList.add("erase");
        });

        document.querySelector('.shape-button').addEventListener('click', function () {
            handleButtonClick('shape-button', false, false);
        });

        document.querySelector('.select-button').addEventListener('click', function () {
            handleButtonClick('select-button', false, true);
        });

        document.querySelector('.delete-button').addEventListener('click', function () {
            canvas.clear();
        });

        const drawStyleButtonSolid = document.querySelector('.customisation-box.draw-button .draw-style-button-solid');
        const drawStyleButtonDashed = document.querySelector('.customisation-box.draw-button .draw-style-button-dashed');

        drawStyleButtonSolid.addEventListener('click', function () {
            switchLineTypes()
        });

        drawStyleButtonDashed.addEventListener('click', function () {
            switchLineTypes()
        });

        function updateLineType() {
            const canvasWidth = 5 * canvas.freeDrawingBrush.width
            if (drawStyleButtonDashed.classList.contains('active')) {
                canvas.freeDrawingBrush.lineDashOffset = 0;
                canvas.freeDrawingBrush.strokeDashArray = [canvasWidth, canvasWidth / 2];
            } else {
                canvas.freeDrawingBrush.lineDashOffset = 0;
                canvas.freeDrawingBrush.strokeDashArray = [];
            }
        }

        const rangeInput = document.getElementById('rangeInput');
        const widthValueInput = document.getElementById('widthValue');

        rangeInput.addEventListener('input', function () {
            widthValueInput.value = this.value;
            canvas.freeDrawingBrush.width = parseInt(this.value, 10);
            updateLineType()

        });

        widthValueInput.addEventListener('input', function () {
            const newValue = this.value;
            if (newValue >= 1 && newValue <= 50) {
                rangeInput.value = newValue;
                canvas.freeDrawingBrush.width = parseInt(this.value, 10);
                updateLineType()
            }
        });

        function switchLineTypes() {
            drawStyleButtonSolid.classList.toggle('active')
            drawStyleButtonDashed.classList.toggle('active')
            updateLineType()
        }

        // Drawing Tool Colour

        const colourPicker = document.querySelector('.colour-picker');
        const colourValueInput = document.getElementById('colourValue');

        // Event listener for the colour picker
        colourPicker.addEventListener('input', function () {
            const newColour = this.value;
            colourValueInput.value = newColour.substr(1).toUpperCase();
            canvas.freeDrawingBrush.colour = this.value;
        });

        // Event listener for the colour value input
        colourValueInput.addEventListener('input', function () {
            const newColour = this.value;
            if (isValidHexcolour(newColour)) {
                colourPicker.value = '#' + newColour;
                canvas.freeDrawingBrush.colour = '#' + newColour;
            }
        });

        // Prevents shortcuts from activating while typing into colour input
        colourValueInput.addEventListener('keydown', function (event) {
            event.stopPropagation();
        });

        // Checks if a given string is a valid hex colour
        function isValidHexcolour(hex) {
            return /^([0-9A-F]{3}){1,2}$/i.test(hex);
        }

        document.addEventListener('keydown', function (event) {
            if (event.key === 's') {
                handleButtonClick('select-button', false, true);
            } else if (event.key === 'd') {
                handleButtonClick('draw-button', true, false);
            } else if (event.key === 'e') {
                handleButtonClick('erase-button', false, false);
                upperCanvas.classList.add("erase");
            } else if (event.key === 'x') {
                handleButtonClick('shape-button', false, false);
            } else if (event.key === 'Delete' || event.key === 'Backspace') {
                canvas.remove(...canvas.getActiveObjects());
            } else if (event.key === 'c') {
                canvas.clear();
            }
        });

        function eraseObjects(event) {
            let pointer = canvas.getPointer(event);
            let objects = canvas.getObjects();

            for (let i = 0; i < objects.length; i++) {
                if (objects[i].containsPoint(pointer)) {
                    canvas.remove(objects[i]);
                }
            }
        }

        /** Shapes **/

            // Border Style
        let shapeOutline = [];

        const shapeStyleButtonSolid = document.querySelector('.customisation-box.shape-button .draw-style-button-solid');
        const shapeStyleButtonDashed = document.querySelector('.customisation-box.shape-button .draw-style-button-dashed');

        shapeStyleButtonSolid.addEventListener('click', function () {
            switchLineTypesShape()
        });

        shapeStyleButtonDashed.addEventListener('click', function () {
            switchLineTypesShape()
        });

        function switchLineTypesShape() {
            shapeStyleButtonSolid.classList.toggle('active')
            shapeStyleButtonDashed.classList.toggle('active')
            const canvasWidth = 5 * canvas.freeDrawingBrush.width
            if (shapeStyleButtonDashed.classList.contains('active')) {
                shapeOutline = [canvasWidth, canvasWidth / 2];
            } else {
                shapeOutline = [];
            }
        }

        // Shape

        let shape = 'circle'

        document.querySelector('.shape-button-circle').addEventListener('click', function () {
            handleShapeButtonClick('circle');
        });

        document.querySelector('.shape-button-ellipse').addEventListener('click', function () {
            handleShapeButtonClick('ellipse');
        });

        document.querySelector('.shape-button-triangle').addEventListener('click', function () {
            handleShapeButtonClick('triangle');
        });

        document.querySelector('.shape-button-square').addEventListener('click', function () {
            handleShapeButtonClick('square');
        });

        document.querySelector('.shape-button-rectangle').addEventListener('click', function () {
            handleShapeButtonClick('rectangle');
        });

        document.querySelector('.shape-button-line').addEventListener('click', function () {
            handleShapeButtonClick('line');
        });

        function handleShapeButtonClick(selectedShape) {
            const buttons = document.querySelectorAll('.shape-section button');
            buttons.forEach(button => button.classList.remove('active'));
            document.querySelector('.shape-button-' + selectedShape).classList.add('active');
            shape = selectedShape
        }

        // Fill

        let innerColour = '#FF0000'

        const colourPickerFill = document.querySelector('.colour-picker.fill');
        const colourValueInputFill = document.getElementById('colourValueFill');

        // Event listener for the colour picker
        colourPickerFill.addEventListener('input', function () {
            const newColour = this.value;
            colourValueInputFill.value = newColour.substr(1).toUpperCase();
            innerColour = this.value
        });

        // Event listener for the colour value input
        colourValueInputFill.addEventListener('input', function () {
            const newColour = this.value;
            if (isValidHexcolour(newColour)) {
                colourPickerFill.value = '#' + newColour;
                innerColour = '#' + newColour;
            }
        });

        // Prevents shortcuts from activating while typing into colour input
        colourValueInputFill.addEventListener('keydown', function (event) {
            event.stopPropagation();
        });

        const visibilitySelectionFill = document.querySelector('.fill-section .visibility-selection');

        visibilitySelectionFill.addEventListener('click', function () {
            visibilitySelectionFill.classList.toggle('active')
        });

        // Outline
        let outerColour = '#FF0000'

        const colourPickerOutline = document.querySelector('.colour-picker.outline');
        const colourValueInputOutline = document.getElementById('colourValueOutline');

        // Event listener for the colour picker
        colourPickerOutline.addEventListener('input', function () {
            const newColour = this.value;
            colourValueInputOutline.value = newColour.substr(1).toUpperCase();
            outerColour = this.value
        });

        // Event listener for the colour value input
        colourValueInputOutline.addEventListener('input', function () {
            const newColour = this.value;
            if (isValidHexcolour(newColour)) {
                colourPickerOutline.value = '#' + newColour;
                outerColour = '#' + newColour;
            }
        });

        // Prevents shortcuts from activating while typing into colour input
        colourValueInputOutline.addEventListener('keydown', function (event) {
            event.stopPropagation();
        });

        const visibilitySelectionOutline = document.querySelector('.outline-section .visibility-selection');

        visibilitySelectionOutline.addEventListener('click', function () {
            visibilitySelectionOutline.classList.toggle('active')
        });

        // Drawing Shapes

        // Event listener for canvas interactions
        let mouseDown = false; // Track mouse button state
        let drawingShape = null;

        canvas.on('mouse:down', function (options) {
            if (options.e.button === 0) {
                mouseDown = true;
                if (activeMode === 'erase-button') {
                    eraseObjects(options.e);
                } else if (activeMode === 'shape-button') {
                    drawingShape = new fabric.Circle({
                        left: options.e.clientX - canvas._offset.left,
                        top: options.e.clientY - canvas._offset.top,
                        radius: 1, // Start with a small radius
                        fill: 'red',
                        originX: 'center',
                        originY: 'center'
                    });
                    canvas.add(drawingShape);
                }
            }
        });

        canvas.on('mouse:up', function () {
            if (drawingShape) {
                if (drawingShape.radius < 10) {
                    canvas.remove(drawingShape);
                } else {
                    drawingShape.setCoords();
                }
                drawingShape = null;
            }
            mouseDown = false;
        });

        canvas.on('mouse:move', function (options) {
            const pointer = canvas.getPointer(options.e);
            if (mouseDown && activeMode === 'erase-button') {
                eraseObjects(options.e);
            } else if (mouseDown && activeMode === 'shape-button' && drawingShape) {
                const dx = pointer.x - drawingShape.left;
                const dy = pointer.y - drawingShape.top;
                const newRadius = Math.sqrt(dx * dx + dy * dy);

                if (newRadius >= 10) { // Minimum radius to keep the circle visible
                    drawingShape.set({radius: newRadius});
                    canvas.renderAll();
                }
            }
        });
    })

</script>
</html>