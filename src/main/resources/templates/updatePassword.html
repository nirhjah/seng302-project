<!--/*
    Update Password.

    Attributes:
    - updatePasswordForm: What our <form> data is bound to
    - user: The currently logged in user. Used for password strength testing
*/-->

<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">

<head>
  <link th:href="@{/css/styles.css}" rel="stylesheet" />
  <link th:href="@{/css/update-password.css}" rel="stylesheet" />
  <link th:href="@{/css/password.css}" rel="stylesheet" />
  <link rel="preload" as="image" th:href="@{/image/landscape.jpeg}">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <meta http-equiv="Content-Type" context="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title th:inline="text">Edit User - Update Password</title>

<body class="edit-user-background">
  <div th:insert="~{fragments/navBar.html::navbar(displayTeams=${displayTeams})}"></div>


  <div class="user-form">
    <div>
      <div class="user-header">
        <h1 th:inline="text">Update Password</h1>
      </div>
      <div class="wrapper">
        <form th:action="@{update-password}" method="post" th:object="${updatePasswordForm}" id="updatePasswordForm">
          <div class="edit-inputs">
            <!--/* Old Password Field */-->
            <div class="input-box">
              <input type="password" class="form-control" th:field="*{oldPassword}"
              data-cy="oldPassword" autocomplete="current-password" autofocus required>
              <label th:for="oldPassword">Old Password <span class="required">*</span></label>
              <img th:src="@{/image/icons/hide.png}" class="password-toggle" data-pw-field="oldPassword" />
            </div>
            <div th:each="err : ${#fields.errors('oldPassword')}" th:text="${err}" class="error-message"></div>
            <!--/* New Password Field */-->
            <div class="input-box">
              <input  type="password" class="form-control" th:field="*{newPassword}"
                data-cy="newPassword" required oninput="checkPasswordStrength(this)" autocomplete="new-password">
              <label th:for="newPassword">New Password <span class="required">*</span></label>
              <img th:src="@{/image/icons/hide.png}" class="password-toggle" data-pw-field="newPassword" />
            </div>
<!--            <div th:each="err : ${#fields.errors('newPassword')}" th:text="${err}" class="error-message"></div>-->
            <div id ="new-password-error" class ="error-message"></div>
            <div class="password-info">
              <div class="password-strength-meter">
                  <div class="bar"></div>
              </div>
              <div class="password-strength-text"></div>
              <ul class="password-information-text">
                  <li id="password-min-characters"><img th:src="@{/image/icons/password-cross.svg}" /> Password must be at least 8 characters</li>
                  <li class="password-items"> Must contain the following items: </li>
                  <ul>
                      <li id ="password-letter-case"><img th:src="@{/image/icons/password-cross.svg}" /> Uppercase and lowercase letters</li>
                      <li id="password-numbers"><img th:src="@{/image/icons/password-cross.svg}" /> Numbers</li>
                      <li id="password-symbols"><img th:src="@{/image/icons/password-cross.svg}" /> Symbols</li>
                  </ul>
                  <li id="password-user-details"><img th:src="@{/image/icons/password-cross.svg}" /> Mustn't contain your name or email</li>
              </ul>
            </div>
            <!--/* Confirm Password Field */-->
            <div class="input-box">
              <input type="password" class="form-control" th:field="*{confirmPassword}"
                data-cy="confirmPassword"  autocomplete="new-password" required>
              <label th:for="confirmPassword">Retype Password <span class="required">*</span></label>
              <img th:src="@{/image/icons/hide.png}" class="password-toggle" data-pw-field="confirmPassword" />
            </div>
              <div th:each="err : ${#fields.errors('confirmPassword')}" th:text="${err}" class="error-message"></div>
            </div>
            <!--/* Submit Button */-->
            <div class="submit-button">
              <label th:if="${errorMessage}" th:text="${errorMessage}" style="position: fixed;"></label>
              <a th:href="@{home}">
                  <button type="submit" id="submit" formnovalidate>Save</button>
              </a>
            </div>
            <!--/* Cancel Button */-->
            <div class="cancel-link">
              <a th:href="@{user-info/self}">Cancel</a>
            </div>
        </form>
      </div>
    </div>
  </div>
  <footer>
      <p>
          Image by <a
              href="https://www.freepik.com/free-vector/flat-happy-children-play-run-cycling-public-park_27059506.htm#query=nature%20sports%20illustration&position=0&from_view=search&track=ais">redgreystock</a>
          on Freepik
      </p>
  </footer>
  <script th:inline="javascript">
    const FIRST_NAME = /*[[ ${#strings.toLowerCase(user.firstName)} ]]*/ "";
    const LAST_NAME = /*[[ ${#strings.toLowerCase(user.lastName)} ]]*/ "";
    const EMAIL = /*[[ ${#strings.toLowerCase(user.email)} ]]*/ "";
    let passwordError = {};
    const errorMessage = document.getElementById("new-password-error");


    /* Reveal Password code */
    const passwordToggle = document.getElementsByClassName('password-toggle');
    for (const button of passwordToggle) {
      const passwordFieldId = button.dataset.pwField;
      const passwordInput = document.getElementById(passwordFieldId);
      button.addEventListener('click', function () {
        if (passwordInput.type === 'text') {
          passwordInput.type = 'password';
          button.src = 'image/icons/hide.png';
        } else {
          passwordInput.type = 'text';
          button.src = 'image/icons/view.png';
        }
      });
    }


    /* Password Strength code, copied from register.html */
    function checkPasswordStrength(elem) {

      const bar = document.querySelector(".password-strength-meter .bar");
      var password = document.getElementById(elem.id).value;
      const minChar= document.getElementById("password-min-characters");
      const hasLetterCase= document.getElementById("password-letter-case");
      const hasNumber= document.getElementById("password-numbers");
      const hasSymbol= document.getElementById("password-symbols");
      const ownDetails= document.getElementById("password-user-details");
      password=password.trim()
      document.getElementById(elem.id).value = password;

      if (password) {
        const minCharImg = minChar.querySelector("img");
        const letterCaseImg = hasLetterCase.querySelector("img");
        const numberImg=hasNumber.querySelector("img");
        const symbolImg= hasSymbol.querySelector("img");
        const detailsImg= ownDetails.querySelector("img");
        const lowerPW = password.toLowerCase();
        let strength = 0;
        if (password.length >= 8) {
          minChar.style.color="green"
          minCharImg.src = "/image/icons/password-tick.svg";
          passwordError.minChar = true;

          strength++;
        }
        else{
          minChar.style.color="red"
          minCharImg.src = "/image/icons/password-cross.svg";
          passwordError.minChar = false;
        }
        if (/[A-Z]/.test(password)) {
          strength++;
        }
        if (/[a-z]/.test(password)) {
          strength++;
        }

        if (/[A-Z]/.test(password) &&/[a-z]/.test(password) ){
          hasLetterCase.style.color="green";
          letterCaseImg.src = "/image/icons/password-tick.svg";
          passwordError.letterCase = true;
        }
        else{
          hasLetterCase.style.color="red";
          letterCaseImg.src = "/image/icons/password-cross.svg";
          passwordError.letterCase = false;
        }
        if (/\d/.test(password)) {
          hasNumber.style.color="green";
          numberImg.src= "/image/icons/password-tick.svg";
          passwordError.hasNumber = true;
          strength++;
        }
        else{
          hasNumber.style.color="red";
          numberImg.src= "/image/icons/password-cross.svg";
          passwordError.hasNumber = false;
        }
        if (/[\W_]/.test(password)) {
          hasSymbol.style.color="green"
          symbolImg.src="/image/icons/password-tick.svg";
          passwordError.hasSymbol = true;
          strength++;
        }
        else{
          hasSymbol.style.color="red";
          symbolImg.src="/image/icons/password-cross.svg";
          passwordError.hasSymbol = false;
        }

        if (!lowerPW.includes(FIRST_NAME) && !lowerPW.includes(LAST_NAME) && !lowerPW.includes(EMAIL)) {
          ownDetails.style.color="green"
          detailsImg.src= "/image/icons/password-tick.svg";
          passwordError.ownDetails = true;
          strength++;
        }
        else{
          ownDetails.style.color="red"
          detailsImg.src="/image/icons/password-cross.svg";
          passwordError.ownDetails = false;
        }

        if (strength < 3) {
          bar.classList.remove("medium");
          bar.classList.remove("strong");
          bar.classList.add("weak");
          bar.style.width = "20%";
        } else if (strength < 6) {
          bar.classList.remove("strong");
          bar.classList.remove("weak");
          bar.classList.add("medium");
          bar.style.width = "50%";
        } else {
          bar.classList.remove("medium");
          bar.classList.remove("weak");
          bar.classList.add("strong");
          bar.style.width = "100%";
        }
      } else {
        bar.classList.remove("medium");
        bar.classList.remove("strong");
        bar.classList.remove("weak");
        bar.style.width = "0%";
      }
      console.log(passwordError)
    }
    const form = document.getElementById("updatePasswordForm");

    form.addEventListener("submit", function(event) {
      if (Object.values(passwordError).some(value => value === false)) {
        event.preventDefault();
        errorMessage.textContent = "Password does not meet the requirements";
      }
    });
  </script>
</body>
</html>