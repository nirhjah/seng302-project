<!--/*
    Edit User Form.

    Attributes:
    - editUserForm: The POJO containing the user's details, should be pre-filled on first load
    - validNameRegex: The valid name pattern (Any language's alphabet, with spaces and hyphens. Otherwise no symbols/numbers)
    - validNameMessage: The message to display if the validNameRegex fails 
*/-->

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">
<head>
    <link th:href="@{/css/styles.css}" rel="stylesheet"/>
    <meta http-equiv="Content-Type" context="text/html; charset=UTF-8">
    <title th:inline="text">Edit User</title>
</head>
<style>
    .multiply:before {
        content: "x";
    }

    .sport-box {
        height:50px;
        width: 280px;
        display: flex;
        flex-wrap: wrap;
        padding: 7px;
        margin: 12px 0;
        border: 1px dashed #a6a6a6;
        overflow-y: scroll;
        max-height: 100px;
        gap: 3px;
        align-content: flex-start;
    }
    .sport-box  li{
        color: #333;
        margin: 0;
        list-style: none;
        border-radius: 20px;
        background: #F2F2F2;
        padding: 5px 8px 5px 10px;
        border: 1px solid #e3e1e1;
        display: inline-block;
        white-space: nowrap;
        font-size: 15px;
        font-weight: 500;
        font-family: "Noto Sans", sans-serif;
    }
    .sport-box  li i{
        height: 80px;
        width: 20px;
        color: #808080;
        margin-left: 8px;
        font-size: 12px;
        cursor: pointer;
        border-radius: 50%;
        background: #dfdfdf;
        justify-content: center;
    }
    .content{
        position:absolute;
        bottom:100px;
    }
    .content input{
        width:295px;
    }
    .content datalist{
        overflow-y:auto;
    }

</style>
<body class="edit-user-background">
    <div th:insert="~{/homeForm.html::navbar(displayTeams=${displayTeams})}"></div>

    <div class="user-form">
        <div class="user-header" style="padding-bottom: 80px;">
            <h1 th:inline="text">Edit User</h1>
        </div>
        <div class="wrapper-edit-profile">
            <form th:action="@{editUser}" method="post" th:object="${editUserForm}" id="editUserForm">
                <div class="input-box">
                    <input type="text" class="form-control"
                           th:field="*{firstName}" data-cy="firstName" required
                           autofocus th:pattern="${validNameRegex}" th:title="${validNameMessage}">
                    <label for="firstName">First Name: </label>
                    <p th:each="err : ${#fields.errors('firstName')}" th:text="${err}" class="errorMessage"  id="firstName"/>
                </div>
                <div class="input-box">
                    <input type="text" class="form-control"
                           th:field="*{lastName}" data-cy="lastName" required
                           autofocus th:pattern="${validNameRegex}" th:title="${validNameMessage}">
                    <label for="lastName">Last Name: </label>
                    <p th:each="err : ${#fields.errors('lastName')}" th:text="${err}" class="errorMessage" id = "lastName"/>
                </div>
                <div class="input-box">
                    <input type="text" class="form-control"
                           th:field="*{email}" data-cy="email" required
                           autofocus>
                    <label for="email">Email
                        <span style="color: darkred">(You will be logged out if you edit your email):</span>
                    </label>
                    <p th:each="err : ${#fields.errors('email')}" th:text="${err}" class="errorMessage" id ="email"/>
                </div>
                <div class="input-box">
                    <input type="date" class="form-control"
                           th:field="*{dateOfBirth}" th:value="*{#dates.formatISO(dateOfBirth)}" data-cy="dateOfBirth" required autofocus>
                    <label for="dateOfBirth">Date of Birth: </label>
                    <p th:each="err : ${#fields.errors('dateOfBirth')}" th:text="${err}" class="errorMessage" id ="dateOfBirth" />
                </div>
                <label for="sport-box"> Favourite Sport</label>
                <div class ="sport-box" id ="sport-box"></div>

<!--                <div class="details">-->
<!--                    <button type ="button">Clear</button>-->
<!--                </div>-->
                </br>
                <div class="submit-button" style="margin-top: 20px;">
                    <a th:href="@{home}">
                        <button type="submit">Save</button>
                    </a>
                </div>
                <div class="cancel-link">
                    <a th:href="@{user-info/self}">Cancel</a>
                </div>
            </form>
            <div class="content">
                <ul><input type="text" spellcheck="false" list="sports"></ul>
                <datalist id="sports">
                    <option value="Swimming">
                    <option value="Netball">
                    <option value="Badminton">
                    <option value="Running">
                    <option value="Tennis">
                    <option value="Volleyball">
                </datalist>
                <div class="details" style="text-align: center;">
                    <button type ="button">Clear</button>
                </div>
            </div>

        </div>

    </div>
    <footer>
        <p>
            Image by <a href="https://www.freepik.com/free-vector/flat-happy-children-play-run-cycling-public-park_27059506.htm#query=nature%20sports%20illustration&position=0&from_view=search&track=ais">redgreystock</a> on Freepik
        </p>
    </footer>

    <script th:inline="javascript">
        const ul = document.querySelector(".content ul"),
            sportDisplay = document.querySelector(".sport-box"),
            input = document.querySelector(".content input");
        const form = document.getElementById("editUserForm");
            let tags =[];
        createTag();
        function createTag(){
            sportDisplay.querySelectorAll("li").forEach(li => li.remove());
            tags.slice().reverse().forEach(tag =>{
                let liTag = `<li>${tag} <i class="multiply" onclick="remove(this, '${tag}')"></i></li>`;
                sportDisplay.insertAdjacentHTML("afterbegin", liTag);
            });
        }

        function remove(element, tag){
            let index  = tags.indexOf(tag);
            tags = [...tags.slice(0, index), ...tags.slice(index + 1)];
            element.parentElement.remove();
            createTag();
        }

        function addTag(e){
            if(e.key == "Enter"){
                e.preventDefault();
                let tag = e.target.value.replace(/\s+/g, ' ');
                if(tag.length > 1 && !tags.includes(tag)){

                    tag.split(',').forEach(tag => {
                        tags.push(tag);
                        createTag();
                    });

                }
                e.target.value = "";
            }
        }

        input.addEventListener("keyup", addTag);

        input.addEventListener("change", (e) => {
            let tag = e.target.value.trim();
            if (tag.length > 0 && !tags.includes(tag)) {
                tags.push(tag);
                createTag();

            }
            e.target.value = "";
        });


        const removeBtn = document.querySelector(".details button");
        removeBtn.addEventListener("click", () =>{
            tags.length = 0;
            sportDisplay.querySelectorAll("li").forEach(li => li.remove());
        });

        // Created a hidden input type for the form tag which contains the tags input, it should return a list of tags in teh controller
        form.addEventListener('submit', (event) => {
            const tagsInput = document.createElement("input");
            tagsInput.setAttribute("type", "hidden");
            tagsInput.setAttribute("name", "tags");
            tagsInput.setAttribute("value", tags.join(","));
            form.appendChild(tagsInput);
            return true;
        });
    </script>
</body>
</html>
